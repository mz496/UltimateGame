$(window).load(function() {
  var game_name = $(".game-name").text().replace(/\n/g,"");

  // PRICES TABLE

  // when clicking a game entry, make its corresponding price appear
  // (and package contents if applicable)
  $(".pricing .game-entry").click(function(e) {
    var selected_class = $(e.target).text().replace(/[^\w\d]/g,"-").toLowerCase();

    // search for currently selected entries; deselect them
    $(".pricing .selected,\
      .extra-info .selected")
    .removeClass("selected").addClass("unselected");

    // search for classes matching the current selection; select them
    $(e.target).removeClass("unselected").addClass("selected");
    $(".pricing ." + selected_class + ",\
      .extra-info ." + selected_class)
    .removeClass("unselected").addClass("selected");

    // send the ajax request using the game name (ITAD URL can only be found with Ruby)
    //if ($(".pricing-entry ." + selected_class + ".ajax-loaded").length)
      // console.log("Already loaded " + selected_class);
    if (!$(".pricing-entry-inner." + selected_class + ".ajax-loaded").length) {
      $(".pricing-entry-inner." + selected_class).addClass("ajax-loaded");
      get_prices(selected_class, $(e.target).text());
      get_extra_info(selected_class, $(e.target).text());
    }
  });



  // (Show original game) button next to anything that isn't the original game
  $(".show-original").click(function(e) {
    var original_class = game_name.replace(/[^\w\d]/g,"-").toLowerCase();

    $(".pricing .selected,\
      .extra-info .selected")
    .removeClass("selected").addClass("unselected");
    
    $(".pricing ." + original_class + ",\
      .extra-info ." + original_class)
    .removeClass("unselected").addClass("selected");
  });



  $(".reload-prices").click(function(e) {
    // placeholder for possible reload price functionality
  })



  // IMAGES VIEW
  /*$(".pics-container-outer").mousewheel(function(e, delta) {
    this.scrollLeft -= (delta*40);
    e.preventDefault();
  });*/
  
  function get_images() {
    $("#horiz_container_outer").prepend('<div class="img-loading-overlay">\
      <div class="img-loading-overlay-inner">\
        <%= image_tag "fancybox_loading.gif" %>\
        Loading images...\
      </div>\
    </div>');

    $.post("/ajax/get_images",
    {input_name: game_name},
    function(data) {
      var images = data.results;
      // console.log(images);

      //var outputHTML = "";
      for (var i = 0; i < images.length; i++) {
        $("#horiz_container").append('<li><a href="' + images[i] + '"\
          class="fancybox"\
          rel="game-images"\
          title="<a href=&quot;' + images[i] + '&quot;>View full resolution</a>">\
          <img src="' + images[i] + '" alt="">\
        </a></li>');
      }

      //$("#horiz_container").append(outputHTML);
      $("#horiz_container_outer .img-loading-overlay").hide(300);
      $("#horiz_container_outer .img-loading-overlay").remove();

      // important: if using thumbs, note application.js where
      // =require jquery.fancybox.pack.js comes before =require jquery.fancybox-thumb.js
      $(".fancybox").fancybox({
        prevEffect: 'elastic',
        nextEffect: 'elastic'
      });

      // make sure everything is loaded before trying to set width
      var total_width = 0;
      $("#horiz_container").imagesLoaded(function() {
        $("#horiz_container li").each(function(index) {
          total_width += parseInt($(this).outerWidth(true), 10);
        });
        // console.log(total_width);

        $("#horiz_container").css("width",(total_width+12)+"px"); // +10 for 5px padding on each side
        $("#horiz_container_outer").horizontalScroll();
      });

      console.log("Finished loading images");

      if (!$("#horiz_container li").length) {
        $("#dragBar").css("display","none");

        $("#horiz_container_outer").prepend('<div class="img-loading-overlay">\
            <div class="img-loading-overlay-inner">\
              Sorry, image loading failed. <a class="reload-images">Reload images</a>\
            </div>\
          </div>');

        $(".reload-images").click(function(e) {
          $("#horiz_container").empty();
          $("#horiz_container_outer .img-loading-overlay").remove();
          get_images();
        });

        console.log("Image load error");
      }
      else {
        $("#dragBar").css("display","block");
      }
    }).fail(function() {
      $("#horiz_container_outer .img-loading-overlay").remove();
      $("#horiz_container_outer").prepend('<div class="img-loading-overlay">\
          <div class="img-loading-overlay-inner">\
            Sorry, image loading failed. <a class="reload-images">Reload images</a>\
          </div>\
        </div>');
    });
  }

  get_images();

  $(".reload-images").click(function(e) {
    $("#horiz_container").empty();
    $("#horiz_container_outer .img-loading-overlay").remove();
    get_images();
  });



  function get_videos() {
    $(".videos").append('<div class="img-loading-overlay">\
      <div class="img-loading-overlay-inner">\
        <%= image_tag "fancybox_loading.gif" %>\
        Loading videos...\
      </div>\
    </div>');

    $.post(
    "/ajax/get_videos",
    {input_name: game_name},
    function(data) {
      $(".videos.left-sidebar").append('<h4 class="section-heading">Game reviews on YouTube</h4>');
      $(".videos.right-sidebar").append('<h4 class="section-heading">Gameplay on YouTube</h4>');

      for (var i = 0; i < data.reviews.names.length; i++) {
        $(".videos.left-sidebar").append('<div>\
          <a class="fancybox-media"\
            rel="reviews"\
            href="' + data.reviews.links[i] + '">' + data.reviews.names[i] +
            '<br><img class="video-img" src="' + data.reviews.image_links[i] + '" />\
          </a>\
        </div>');
      }

      for (var i = 0; i < data.gameplay.names.length; i++) {
        $(".videos.right-sidebar").append('<div>\
          <a class="fancybox-media"\
            rel="gameplay"\
            href="' + data.gameplay.links[i] + '">' + data.gameplay.names[i] +
            '<br><img class="video-img" src="' + data.gameplay.image_links[i] + '" />\
          </a>\
        </div>');
      }

      $(".fancybox-media").fancybox({
        prevEffect: "none",
        nextEffect: "none",
        mouseWheel: false,
        padding: 0,
        margin: [20, 60, 20, 60],
        helpers: {
          media: {}
        }
      });

      $(".videos .img-loading-overlay").hide(300);
      $(".videos .img-loading-overlay").remove();
      console.log("Finished loading videos");
    }).fail(function() {
      $(".videos").empty();
      $(".videos").prepend('<div class="img-loading-overlay">\
        <div class="img-loading-overlay-inner">\
          Sorry, video loading failed. <a class="reload-videos">Reload videos</a>\
        </div>\
      </div>');

      $(".reload-videos").click(function(e) {
        $(".videos").empty();
        get_videos();
      });
    });
  }

  get_videos();



  function get_reddit_info() {
    $(".reddit-container").append('<div class="img-loading-overlay">\
      <div class="img-loading-overlay-inner">\
        <%= image_tag "fancybox_loading.gif" %>\
        Loading Reddit posts...\
      </div>\
    </div>');

    $.post("/ajax/get_reddit",
    {input_name: game_name},
    function(data) {
      output = data.results;
      //console.log(output);

      var outputHTML = "";

      for (var i = 0; i < output.length; i++) {
        var source_url = "";
        var source_text = "";
        var is_reddit_internal = new RegExp(/https?:\/\/www\.reddit\.com\/r\/([^\/]*)\//);
        var is_external = new RegExp(/https?:\/\/(www\.)?([^\/]*)\//);

        if (is_reddit_internal.test(output[i].link)) {
          source_url = "http://www.reddit.com/r/" + output[i].link.match(is_reddit_internal)[1];
          source_text = "(self." + output[i].link.match(is_reddit_internal)[1] + ")";
        }
        else if (is_external.test(output[i].link)) {
          source_url = "http://www.reddit.com/domain/" + output[i].link.match(is_external)[2];
          source_text = "(" + output[i].link.match(is_external)[2] + ")";
        }

        outputHTML += '<div>\
          <a class="reddit-entry" href="' + output[i].link + '">' + output[i].name + '</a> <a class="reddit-source"\
          href="' + source_url + '">' + source_text + '</a> <a class="reddit-comments" href="' + output[i].comments + '">(comments)</a>\
        </div>';
      }

      $(".reddit-container .img-loading-overlay").remove();
      $(".reddit-container").append(outputHTML);
    });
  }

  get_reddit_info();



  function get_search_results() {
    $(".search-results-container").append('<div class="img-loading-overlay">\
      <div class="img-loading-overlay-inner">\
        <%= image_tag "fancybox_loading.gif" %>\
        Loading search results...\
      </div>\
    </div>');

    $.post("/ajax/get_search_results",
    {input_name: game_name},
    function(data) {
      output = data.results;
      //console.log(output);

      var outputHTML = "";

      for (var i = 0; i < output.length; i++) {
        var link = output[i];
        var shortened = new RegExp(/http:\/\/www.([^\/]*)\//);

        if (shortened.test(link)) {
          var text = link.match(shortened)[1];

          outputHTML += '<li><a href="' + link + '">' + text + '</a></li>';
        }
      }

      $(".search-results-container .img-loading-overlay").remove();
      $(".search-results-container ul").append(outputHTML);
    })
  }

  get_search_results();



  // COLLAPSIBLE CONTAINERS
  var original_height = "300px";

  $(".collapsible")
  .css("max-height", original_height)
  .css("overflow", "hidden");

  $(".description-container, .reqs-container").each(function(index, elem) {
    if ($(elem).prop("scrollHeight") <= $(elem).height()) {
      $(elem).siblings(".collapser").hide();
    }
  });

  $(".collapser").click(function(e) {
    var collapsible = $(e.target).siblings(".collapsible");

    if (collapsible.css("max-height") === original_height) {
      collapsible.css("max-height","none");
      $(e.target).text("Read less...");
    }
    else {
      collapsible.css("max-height",original_height);
      $(e.target).text("Read more...");
    }
  });



  // PERCENTAGE DIALS
  $(".dial").knob({
    "width": 120,
    "height": 120,
    "thickness": 0.2,
    "bgColor": "rgba(255,255,255,0.2)",
    "readOnly": true,
  });

  $(".dial")
  .css("font-size", "40pt")
  .css("height", "120px")
  .css("width", "120px")
  .css("margin", "0 0 0 -120px");



  // SECTION HEADING LINES
  $(".section-heading").each(function(index, elem) {
    var line = $(elem).children("span").first();
    line.css("width", 800-$(elem).children(".title").first().width() + "px");
  });

  // Adjust height of detail info in hltb-detail (Game statistics) to match hltb table
  $(".detail-container").css("height", $(".hltb-container").css("height"));
});



/* END OF FUNCTION THAT WILL BE CALLED ON PAGE LOAD */



function get_prices(selected, input_name_text) {
  $(".pricing-entry-inner." + selected).append('<div class="price-loading-overlay">\
    <%= image_tag "fancybox_loading.gif" %>\
    Loading prices...<br>');/*(Taking too long? <a class="reload-prices">Reload this view</a>)\
  </div>');*/

  // ajax request: format the table based on hash received from data.results
  $.post("/ajax/get_prices", // get_prices.json
  {input_name: input_name_text},
  function(data) {
    var output = data.results;
    // console.log(output);

    var outputHTML = '<tr>\
      <th>Vendor</th>\
      <th>Price</th>\
      <th style="width:80px">Lowest recorded</th>\
    </tr>';

    for (var i = 0; i < output.length; i++) {
      outputHTML += '<tr>\
        <td><a href="' + output[i].store_url + '">' + output[i].store + '</a></td>\
        <td>' + output[i].current_price + ' (' + output[i].price_cut + ')</td>\
        <td>' + output[i].lowest_recorded + '</td>\
      </tr>'
    }

    $(".pricing-entry-inner." + selected + " .price-loading-overlay").remove();
    $(".pricing-entry-inner." + selected + " table").append(outputHTML);
  });
}



function get_extra_info(selected, input_name_text) {
  $(".extra-info ." + selected).append('<div class="price-loading-overlay">\
    <%= image_tag "fancybox_loading.gif" %>\
    Loading information...<br>');

  $.post("/ajax/get_extra_info",
  {input_name: input_name_text},
  function(data) {
    var output = data.results;
    //console.log(output);

    var releasedate = output.releasedate || "Unknown";
    var website = output.website || "";
    if (output.steamid)
      var steam_link = "http://store.steampowered.com/app/" + output.steamid;
    else
      var steam_link = "http://store.steampowered.com";      

    var outputHTML =
    '<div class="col-md-6 headerimg">\
      <img class="extra-img" src="' + output.headerimg + '" />\
    </div>\
    <div class="col-md-6 links">\
      <h4>' + output.name + '</h4>\
      <ul>\
        <li>Released: ' + releasedate + '</li>\
        \
        <li>Website:\
          <a href="' + website + '">' + website.replace("http://","").replace(/\.com\/$/,".com") + '</a>\
        </li>\
        \
        <li>\
          <a href="' + steam_link + '">View on Steam</a>\
        </li>\
        \
        <li>\
          <a href="#' + selected + '-description" class="fancybox-text">Read description</a>\
          <div class="description-popup" id="' + selected + '-description">' + output.description + '</div>\
        </li>\
      </ul>\
    </div>';

    $(".extra-info ." + selected + " .price-loading-overlay").remove();
    $(".extra-info ." + selected).append(outputHTML);

    $(".fancybox-text").fancybox({
      openEffect: "fade",
      closeEffect: "fade",
      maxWidth: 600,
      autoWidth: false
    });
  });
}